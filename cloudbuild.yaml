steps:

- id: build
  name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/mhs-reddit/gather-bot-image', '.']
  
- id: push
  name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/mhs-reddit/gather-bot-image']

- id: proxy-install
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: bash
  args:
    - -c
    - curl -o /workspace/cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.0.0/cloud-sql-proxy.linux.amd64 && chmod +x /workspace/cloud-sql-proxy

- id: testing
  name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: - -c
        - |
        /workspace/cloud-sql-proxy -instances=mhs-reddit:northamerica-northeast2:mhs-db=tcp:172.26.0.3:5432 & sleep 2 
        docker run gcr.io/mhs-reddit/gather-bot-image python3 manage.py test
  waitFor: [build, push, proxy-install]

images:
- gcr.io/mhs-reddit/gather-bot-image